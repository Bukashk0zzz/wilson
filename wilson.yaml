pipelines:
  build:
    - name: Build "darwin"
      task: build
      env:
        GOOS: darwin
        BIN_OUT: bin/wilson_darwin_amd64
    - name: Build "linux"
      task: build
      env:
        GOOS: linux
        BIN_OUT: bin/wilson_linux_amd64

  release:
    - task: build
      env:
        GOOS: darwin
        BIN_OUT: bin/wilson_darwin_amd64
    - task: update-cmd-version
    - task: update-brew-formula
      depends_on: build
    - task: push-tag
      depends_on: [update-brew-formula]

tasks:
  build:
    command:
      - GOOS=${GOOS} GOARCH=amd64 go build -o ${BIN_OUT} main.go

  update-cmd-version:
    command:
      - sed -i '' '/Version:/s/".*"/"'${ARGS}'"/' cmd/cmd.go
      - git add cmd/cmd.go

  update-brew-formula:
    command:
      - tar -zcvf bin/wilson-darwin-amd64.tar.gz bin/wilson_darwin_amd64
      - sed -i '' '/  version/s/".*"/"'${ARGS}'"/' wilson.rb
      - sed -i '' '/  sha256/s/".*"/"'$(shasum -a256 bin/wilson-darwin-amd64.tar.gz | awk '{print $1}')'"/' wilson.rb
      - git add wilson.rb

  push-tag:
    command:
      - git commit -m "Release ${ARGS}"
      - git tag ${ARGS}
      - git push origin master
      - git push origin ${ARGS}
